# 2026-02-18

## Translation Pipeline (Eventranz) - XLSX Runs Failing

- Observed failing Telegram job: `job_telegram_20260218_113105_9dafd12a` ended in `needs_attention`.
- Root issues:
  - XLSX preserve coverage hard-gate expected `2043` cells because extraction included *all* text cells across all sheets (including many English-only template cells).
  - Gemini reviewer returned positive `findings` even when `pass=true`; orchestrator treated `findings` as fix instructions, triggering Codex "fix" that could wipe `xlsx_translation_map`.
  - Vision format QA sometimes fails with HTTP 403 (key restricted), which previously crashed the QA step and surfaced as `format_qa_error`.

## Fixes Implemented

- `scripts/xlsx_preserver.py`
  - Added `arabic_only` extraction option.
  - Added `interview_only_if_present` sheet focus (if any sheet starts with `Interview_`, only those sheets are extracted).
  - Added optional `sheet_include_regex` / `sheet_exclude_regex`.
- `scripts/openclaw_translation_orchestrator.py`
  - For `SPREADSHEET_TRANSLATION`, omit large `candidate_files[].content` from the execution context to reduce prompt bloat.
  - Pass XLSX extraction options via env:
    - `OPENCLAW_XLSX_ARABIC_ONLY` (default on when `source_language` is Arabic)
    - `OPENCLAW_XLSX_FOCUS_INTERVIEW_SHEETS` (default on for spreadsheet jobs)
    - `OPENCLAW_XLSX_SHEET_INCLUDE_REGEX`, `OPENCLAW_XLSX_SHEET_EXCLUDE_REGEX`
  - Fix: only use Gemini `unresolved` (or `findings` when `pass=false`) as fix instructions.
  - Fix: preserve non-empty `docx_translation_map` / `xlsx_translation_map` when applying a "fix" draft that omits them.
  - Format QA: treat `status=skipped` as non-fatal (do not mark as failed).
- `scripts/format_qa_vision.py`
  - Catch vision failures (e.g., HTTP 403) and return `status=skipped` instead of raising/crashing the job.
- Tests:
  - Added extraction tests for Arabic-only + interview-sheet focus.
  - Updated one status-card test expectation to match current stage formatting.

## Tauri App Frontend Review (tauri-app)

- `fetchLogs()` log parsing does not match real log format (`YYYY-MM-DD HH:MM:SS [run-worker] INFO ...` / `[tg-bot] WARNING ...`), so log level/time/service parsing + filters likely break.
- `get_quality_report` expects `_VERIFY/<job_id>/quality_report.json` with `terminology_hit/structure_fidelity/purity_score`, but current pipeline output is `_VERIFY/<job_id>/.system/quality_report.json` with a different schema, so Verify page quality panel will never populate as-is.
- Settings UI clears "Unsaved changes" even when save fails because `saveConfig()` swallows errors; needs return value or thrown error handling.
- Services page per-service Start/Stop buttons call global start/stop (all services), which is misleading.
- `KBHealth` page is currently mock data (not wired to backend).
