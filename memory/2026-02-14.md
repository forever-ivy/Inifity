# 2026-02-14

- Updated `scripts/translation_team_demo.py` to auto-detect Claude Code teams under `~/.claude/teams` (matching current repo `cwd`) and added `--list/--team/--config-path` options.
- Script now prints members/info for the detected team config format (Claude Code schema) and keeps legacy schema support.
- User asked how the translation model "modes" are designed in this repo and wants to modify/improve them (task_type prompts + preserve/reflow outputs).
- Implemented company-aware KB workflow: `run` now prompts for company selection via numeric reply; KB retrieval filters `30_Reference/{Company}` (with global glossary/style still allowed by default). Added post-run FINAL upload handling (Telegram attachments into `_VERIFY/{job_id}/FinalUploads/`) and `ok` now archives those FINAL files into `Knowledge Repository/30_Reference/{Company}/{Project}/final/` with a manifest. Upgraded local KB retrieval to SQLite FTS5 BM25 with fallback, and improved ClawRAG sync to include metadata-only changes.
- Implemented translation-mode refactor:
  - Removed Draft artifacts (only `Final.docx` + `Final-Reflow.docx` + reports).
  - Added GLM as a second generator candidate each round; Gemini reviews both and selects best.
  - Generalized required input slots to `source_*` / `target_*` (no Arabic/English hardcoding) with legacy mapping.
  - Added Gemini Vision XLSX format QA module with multi-sheet support and integrated optional QA gate via `OPENCLAW_FORMAT_QA_ENABLED`.
  - Updated schemas/docs/tests; test suite passes (`63/63`).

- Implemented format-preserving Excel/Word pipeline + stronger vision QA:
  - Added XLSX/DOCX preserve payloads (cell/unit extraction) and translation-map outputs (`xlsx_translation_map`, `docx_translation_map`).
  - `scripts/xlsx_preserver.py`: apply translations into copied workbook; optional non-structural beautify (wrap_text + row height bump).
  - `scripts/docx_preserver.py`: best-effort run-preserving text replacement (keeps structure and run formatting heuristically).
  - `scripts/format_qa_vision.py`: Gemini Vision QA now reports aesthetics + fidelity; fidelity gates pass/fail; aesthetics is warning-only.
  - `scripts/docx_qa_vision.py`: DOCX page render + Gemini Vision QA (fidelity + aesthetics) with mismatch reporting.
  - Orchestrator supports multi-xlsx outputs (`xlsx_files`) and optional DOCX QA gating (`OPENCLAW_DOCX_QA_ENABLED`).
  - Updated schema/docs/env examples; setup script default model now `openai-codex/gpt-5.2-codex`.
  - Added tests for XLSX/DOCX preservers + vision QA aggregation; full suite passes (`69/69`).
  - Adjusted `ok` command default behavior to remain status-only (no final-upload requirement unless explicitly enabled).
