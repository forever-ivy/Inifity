# 2026-02-19

## Tauri + Pipeline Full-Stack Fixes (Verify/Logs/KBHealth/GLM/QA/Services)

### Tauri (Rust + Frontend)
- Verify paths fixed to use `Translated -EN/_VERIFY/<job_id>` and quality reads `.system/quality_report.json` (metrics 0..1 -> 0..100%).
- Verify UI now shows a quality panel even when unavailable/skipped, and avoids stale artifacts by clearing selection on job switch.
- Logs parsing fixed in store to match real log format (`YYYY-MM-DD HH:MM:SS [tag] LEVEL msg`), normalize `WARNING -> WARN`, and tolerate JSON lines.
- Settings save flow: save errors now keep "Unsaved changes"; Rust writer preserves quoted paths in `.env.v4.local`.
- Jobs milestones: ISO timestamps (`2026-...T...+00:00`) now render correctly.
- Jobs milestones: when a selected job is `running`, the UI polls milestones so Round 1/2/3 updates appear live.
- KBHealth is now real (no mock): pulls latest KB sync report + sqlite stats; supports "Sync Now".
- Services: per-row Start/Stop now controls single service (telegram/worker); preflight button debounced.

### Pipeline (Python)
- GLM: `OPENCLAW_GLM_ENABLED` now gates BOTH GLM generator in rounds and post-round GLM advisory review.
- GLM direct API fallback now reads key from `~/.openclaw/agents/main/agent/auth-profiles.json` when `GLM_API_KEY` env is missing (prefers `zai:default`, then `lastGood["zai"]`).
- QA resiliency: XLSX/DOCX vision QA now returns `status=skipped` when LibreOffice/soffice render fails or vision call unavailable; orchestrator treats DOCX skipped as non-fatal.
- Worker: reloads repo-root `.env.v4.local` before each job and passes a filtered env to the pipeline subprocess so toggles/keys take effect without restarting.
- Notifications: round milestones (`round_1_done`/`2`/`3`) are now emitted **real-time** via orchestrator callback; messages show actual `Gen(model)` + `Review(model)` instead of hard-coded Codex/Gemini.
- Intent fallback: when intent classifier fails with provider schema errors (`intent_json_parse_failed`), orchestrator now applies heuristic classification instead of hard-failing the job.
- Intent routing is now decoupled via `OPENCLAW_INTENT_AGENT` (default `task-router`) so classifier reliability no longer depends on `translator-core` model cooldown/fallback state.
- Added `OPENCLAW_INTENT_CLASSIFIER_MODE` (`hybrid`/`heuristic`) to force local intent classification when absolute reliability is required.
- Production env set to `OPENCLAW_INTENT_CLASSIFIER_MODE=heuristic` to eliminate intent-stage provider/schema failures entirely.

### Verification
- Python unit tests: `unittest discover` OK.
- Frontend: `npm run build` OK.
- Rust: `cargo build` OK.

## Tauri UI - KB Files Manager + Services Preflight Display

- Added Tauri command `list_kb_files` (sqlite `kb_files` pagination + filters) and frontend KB Health "Knowledge Base Documents" table (search, source-group filter, paging, open-in-finder, sync details).
- Services preflight UI is now responsive (`grid-cols-1/2/3`), action buttons wrap on small widths, and details default to "issues only" with a toggle.

## KB Glossary Enforcer (Company-Scoped, Strict)

- Added `scripts/kb_glossary_enforcer.py` to parse `00_Glossary/<Company>` bilingual term pairs from `.xlsx` / `.docx`.
- Pipeline now passes `kb_root` + `kb_company` into orchestrator; orchestrator selects only glossary terms that appear in the job's source units/cells and hard-gates if translated units/cells don't contain the required English term.
- Controlled via env: `OPENCLAW_GLOSSARY_ENFORCER_ENABLED` (default on), `OPENCLAW_GLOSSARY_ENFORCER_MAX_TERMS`, `OPENCLAW_GLOSSARY_ENFORCER_MAX_VIOLATIONS`.

## XLSX Partial-Translation Root Cause + Fix

- Diagnosed `job_telegram_20260219_052749_c13dd8e0`: each round produced a *different subset* of `xlsx_translation_map` by file:
  - Round 2 covered the 2 files that Round 3 omitted; Round 3 covered the other 4 files.
  - Orchestrator treated round outputs as full snapshots and overwrote the previous `xlsx_translation_map`, causing “half translated” outputs.
- Implemented robust merge semantics in `scripts/openclaw_translation_orchestrator.py`:
  - `_preserve_nonempty_translation_maps` now merges DOCX maps by unit id and XLSX maps by (file,sheet,cell), preferring newer entries.
  - Generators now merge incremental preserve maps forward across rounds when `current_draft` exists.
  - Hard-gate retry budget reset per-round (instead of being consumed entirely in round 1).
- Fixed convergence blockers:
  - Gemini reviewer “empty placeholder” reviews (pass=false, all metrics 0, no findings) are now treated as unavailable -> triggers `degraded_single_model`.
  - Vision QA `status=skipped` now yields warnings (not findings), so Vision 403/missing deps won't block a pass.
- Added tests:
  - Spreadsheet merge across rounds reaches `review_ready` with merged `xlsx_translation_map`.
  - Empty Gemini reviews degrade to single-model and still reach `review_ready`.

## OpenClaw Fallback Routing - Kimi Before GLM

- Integrated `moonshot/kimi-k2.5` into the global OpenClaw fallbacks list **before** any `zai/glm-*` entries.
- Hooked into Tauri `Services → Auto Fix All` (best-effort; no live probe) and `scripts/setup_openclaw_v4.sh` (preserve existing fallbacks; insert/move Kimi before GLM).
- Added `moonshot` provider to API Config provider list so the Kimi key can be managed in UI.
- Added Rust unit tests for fallback ordering helper; `cargo test` + `npm run build` OK.

## Vision QA - Kimi (Moonshot) Backend

- Vision QA (XLSX `format_qa_vision.py` + DOCX `docx_qa_vision.py`) now supports Moonshot Kimi and will fall back from Gemini automatically when `OPENCLAW_VISION_BACKEND=auto` and Gemini is unavailable.
- Credentials: uses `MOONSHOT_API_KEY` **or** `~/.openclaw/agents/main/agent/auth-profiles.json` (`moonshot:default`) so Vision QA no longer requires `GOOGLE_API_KEY/GEMINI_API_KEY`.
- Tauri preflight + ApiConfig Runtime Availability updated to treat Moonshot as a valid Vision credential; Auto Fix + `scripts/setup_openclaw_v4.sh` also sets OpenClaw `imageModel` to Kimi (best-effort).

## Classification + Generator Hard-Fail Guardrails (Job `job_telegram_20260219_152255_e2f39473`)

- Fixed heuristic intent language inference so repeated same-language candidates no longer produce `ar -> ar`; now dedupes candidate languages and defaults single-source Arabic-like jobs to target `en`.
- Added typo-tolerant language parsing for English target hints (`englsih`/`englsh`/`inglish`) to avoid misclassification when users misspell "English".
- Added generator fail-safe in `scripts/openclaw_translation_orchestrator.py`: if OpenClaw returns provider schema error (`patternProperties`) for `translator-core`, the pipeline now attempts Kimi direct API fallback first, then GLM direct API fallback before declaring `no_generator_candidates`.
- Added unit tests for language inference regression and Kimi direct fallback trigger path; orchestrator test suite passes (`13/13`).

## Translator-Core hard-fail root cause found (session model pin + google schema incompat)

- Repeated job failure (`no_generator_candidates: codex=agent_provider_schema_rejected`) traced to `translator-core` routing into `google-antigravity/claude-opus-4-6-thinking`, which returns a provider schema error (`patternProperties`) under current tool payload.
- Added orchestrator failover guard: `_codex_generate` now tries secondary OpenClaw agent (`OPENCLAW_CODEX_FALLBACK_AGENT`, default `qa-gate`) before direct Kimi/GLM API fallbacks.
- Added unit test to lock this behavior (`test_codex_generate_uses_fallback_agent_before_direct_api`).
- Verified test suite: `14/14` passing.

## Prompt-size hardening for spreadsheet jobs (2MB provider limit)

- Fixed hard-fail pattern `codex_json_parse_failed` caused by oversized model request payloads (`total message size ... exceeds limit 2097152`).
- Added prompt compaction in `_codex_generate`: drop KB/cross-job context first, trim XLSX cell text payloads for prompt, compact large previous drafts, and fail with explicit `prompt_too_large` if still over cap.
- Added KB payload compaction in execution context builder and reduced default `OPENCLAW_XLSX_MAX_CHARS_PER_CELL` from `400` to `160`.
- Added tests for KB compaction + XLSX prompt text trimming; full orchestrator suite now `16/16` passing.
